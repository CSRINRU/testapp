<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>レシート管理</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Local AI Libraries -->
    <script src="lib/ort.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="manifest.json">
</head>

<body>
    <div class="container">
        <!-- ヘッダー -->
        <header class="header">
            <h1><i class="fas fa-receipt"></i> レシート管理</h1>
            <p class="subtitle">レシートを撮影して自動で家計簿に</p>
        </header>

        <!-- メインナビゲーション -->
        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="camera">
                <i class="fas fa-camera"></i> 撮影
            </button>
            <button class="nav-tab" data-tab="list">
                <i class="fas fa-list"></i> レシート一覧
            </button>
            <button class="nav-tab" data-tab="analysis">
                <i class="fas fa-chart-pie"></i> 分析
            </button>
            <button class="nav-tab" data-tab="settings">
                <i class="fas fa-cog"></i> 設定
            </button>
        </nav>

        <!-- タブコンテンツ -->
        <div class="tab-content active" id="camera-tab">
            <div class="section-header">
                <h2><i class="fas fa-camera"></i> レシート撮影</h2>
                <p>レシートを撮影して内容を自動解析します</p>
            </div>

            <!-- Camera Start Screen (Initial View) -->
            <div id="camera-start-screen" class="camera-start-screen">
                <div class="start-screen-content">
                    <div class="icon-circle">
                        <i class="fas fa-camera"></i>
                    </div>
                    <h3>レシート撮影</h3>
                    <p>ボタンを押して撮影を開始します</p>
                    <button id="startCaptureBtn" class="btn btn-primary btn-large pulse-animation">
                        <i class="fas fa-camera"></i> 撮影開始
                    </button>
                    <label for="fileInputStart" class="btn btn-secondary btn-large mt-3">
                        <i class="fas fa-upload"></i> 画像を選択
                    </label>
                    <input type="file" id="fileInputStart" accept="image/*" class="hidden">
                    <input type="file" id="fileInput" accept="image/*" class="hidden"> <!-- 既存のinputも維持または統合 -->
                </div>
            </div>

            <!-- Actual Camera Container (Hidden initially) -->
            <div id="camera-container" class="camera-container hidden-camera">
                <div class="camera-view">
                    <video id="cameraPreview" autoplay playsinline></video>
                    <canvas id="photoCanvas" class="hidden"></canvas>
                    <img id="selectedImagePreview" class="hidden">
                    <div id="cameraOverlay" class="camera-overlay">
                        <div class="overlay-text">レシートを枠内に収めてください</div>
                    </div>
                    <button id="closeCameraBtn" class="close-camera-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="camera-controls">
                    <button id="captureBtn" class="capture-action-btn">
                        <div class="shutter-inner">
                            <i class="fas fa-camera"></i>
                        </div>
                    </button>
                    <button id="switchCameraBtn" class="btn btn-secondary">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>

            </div>

            <div class="processing-section hidden" id="processingSection">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>レシートを解析中...</p>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p class="progress-text" id="progressText">初期化中...</p>
            </div>

            <!-- Preprocessing Section (Initially Hidden) -->
            <div id="preprocessing-section" class="preprocessing-section hidden">
                <div class="section-header">
                    <h3><i class="fas fa-sliders-h"></i> 画像補正 & パラメータ調整</h3>
                </div>

                <div class="preprocessing-content">
                    <div class="preprocessing-preview-single">
                        <label>AI入力画像（前処理後）</label>
                        <canvas id="prepProcessedCanvas"></canvas>
                    </div>

                    <!-- Tabs Navigation -->
                    <div class="preprocessing-tabs">
                        <button class="prep-tab-btn active" data-target="prep-tab-quality">
                            <i class="fas fa-image"></i> 画質
                        </button>
                        <button class="prep-tab-btn" data-target="prep-tab-detection">
                            <i class="fas fa-expand"></i> 検出
                        </button>
                        <button class="prep-tab-btn" data-target="prep-tab-recognition">
                            <i class="fas fa-font"></i> 認識
                        </button>
                    </div>

                    <!-- Tab Content: Quality -->
                    <div id="prep-tab-quality" class="prep-tab-content active">
                        <!-- Contrast Card -->
                        <div class="control-card">
                            <div class="card-header">
                                <i class="fas fa-adjust"></i> コントラスト設定
                            </div>
                            <div class="control-row">
                                <span class="control-label">コントラスト機能</span>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="check-contrast" checked>
                                    <label for="check-contrast" class="toggle-slider"></label>
                                </div>
                            </div>
                            <div class="control-row">
                                <span class="control-label">強度: <span id="disp-contrast">1.3</span></span>
                                <input type="range" id="slider-contrast" min="0.5" max="3.0" step="0.1" value="1.3">
                            </div>
                        </div>

                        <!-- Sharpening Card -->
                        <div class="control-card">
                            <div class="card-header">
                                <i class="fas fa-magic"></i> シャープニング設定
                            </div>
                            <div class="control-row">
                                <span class="control-label">シャープニング機能</span>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="check-sharpening" checked>
                                    <label for="check-sharpening" class="toggle-slider"></label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Detection -->
                    <div id="prep-tab-detection" class="prep-tab-content">
                        <!-- Limit Side Len Card -->
                        <div class="control-card">
                            <div class="card-header">
                                <i class="fas fa-ruler-combined"></i> 最大辺長 (Limit Side Len)
                            </div>
                            <div class="control-row stacked">
                                <span class="control-label">値: <span id="disp-limitSide">2000</span>px</span>
                                <input type="range" id="slider-limitSide" min="640" max="3200" step="32" value="2000">
                                <p class="control-desc">画像の長辺をこのサイズにリサイズして検出を行います。</p>
                            </div>
                        </div>

                        <!-- Det Threshold Card -->
                        <div class="control-card">
                            <div class="card-header">
                                <i class="fas fa-filter"></i> 検出閾値 (Det Threshold)
                            </div>
                            <div class="control-row stacked">
                                <span class="control-label">値: <span id="disp-detThresh">0.4</span></span>
                                <input type="range" id="slider-detThresh" min="0.1" max="0.9" step="0.05" value="0.4">
                                <p class="control-desc">テキスト領域とみなす確率の閾値です。低すぎるとノイズを拾い、高すぎると薄い文字を見逃します (推奨: 0.3-0.5)。</p>
                            </div>
                        </div>

                        <!-- Box Threshold Card -->
                        <div class="control-card">
                            <div class="card-header">
                                <i class="fas fa-vector-square"></i> Box閾値 (Box Threshold)
                            </div>
                            <div class="control-row stacked">
                                <span class="control-label">値: <span id="disp-boxThresh">0.6</span></span>
                                <input type="range" id="slider-boxThresh" min="0.1" max="0.9" step="0.05" value="0.6">
                                <p class="control-desc">検出された領域の確からしさ(平均スコア)の閾値です。ノイズ除去に効果的です (推奨: 0.5-0.7)。</p>
                            </div>
                        </div>
                        <!-- Padding Ratio Card -->
                        <div class="control-card">
                            <div class="card-header">
                                <i class="fas fa-expand-arrows-alt"></i> パディング率 (Padding Ratio)
                            </div>
                            <div class="control-row stacked">
                                <span class="control-label">値: <span id="disp-padding">0.1</span></span>
                                <input type="range" id="slider-padding" min="0.0" max="0.5" step="0.05" value="0.1">
                                <p class="control-desc">検出領域に追加する余白の割合です。文字切れを防ぐために調整します (推奨: 0.1-0.2)。</p>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Recognition -->
                    <div id="prep-tab-recognition" class="prep-tab-content">
                        <!-- Rec Threshold Card -->
                        <div class="control-card">
                            <div class="card-header">
                                <i class="fas fa-check-double"></i> 認識閾値 (Rec Threshold)
                            </div>
                            <div class="control-row stacked">
                                <span class="control-label">値: <span id="disp-recThresh">0.6</span></span>
                                <input type="range" id="slider-recThresh" min="0.1" max="1.0" step="0.05" value="0.6">
                                <p class="control-desc">文字認識の信頼度がこれより低い場合は結果を破棄します。誤読を減らすのに有効です (推奨: 0.5-0.7)。</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="preprocessing-actions">
                    <button id="prepCancelBtn" class="btn btn-secondary">キャンセル</button>
                    <button id="prepAnalyzeBtn" class="btn btn-primary btn-large">
                        <i class="fas fa-search"></i> 解析開始
                    </button>
                </div>
            </div>
        </div>

        <!-- Debug UI Section -->
        <!-- Debug UI Section -->
        <div id="debug-ui-section" class="debug-ui-section hidden">
            <div class="debug-ui-header">
                <h2>OCR認識結果確認</h2>
                <div class="debug-ui-header-actions">
                    <button id="debug-retry-btn" class="btn btn-secondary btn-small"
                        style="background-color: #555; color: white; border: 1px solid #666;">キャンセル</button>
                    <button id="debug-continue-btn" class="btn btn-primary btn-small">続行 (Geminiへ)</button>
                </div>
            </div>

            <div class="debug-ui-body">
                <!-- Image Canvas Area -->
                <div id="debug-ui-container" class="debug-ui-canvas-container">
                    <canvas id="debug-canvas"></canvas>
                </div>

                <!-- Text List Sidebar -->
                <div class="debug-ui-sidebar">
                    <div class="debug-sidebar-header">認識テキスト一覧</div>
                    <div id="debug-text-list">
                        <!-- Items populated by JS -->
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="list-tab">
            <div class="section-header">
                <h2><i class="fas fa-list"></i> レシート一覧</h2>
                <div class="filter-controls">
                    <select id="filterPeriod" class="filter-select">
                        <option value="all">すべての期間</option>
                        <option value="week">直近1週間</option>
                        <option value="month">直近1ヶ月</option>
                        <option value="3months">直近3ヶ月</option>
                        <option value="custom">カスタム期間</option>
                    </select>
                    <select id="filterCategory" class="filter-select">
                        <option value="all">すべてのカテゴリ</option>
                        <option value="food">食料品</option>
                        <option value="daily_goods">日用品</option>
                        <option value="misc">雑貨</option>
                        <option value="clothing">衣服</option>
                        <option value="luxury">嗜好品</option>
                        <option value="other">その他</option>
                    </select>
                    <select id="sortOrder" class="filter-select">
                        <option value="dateDesc">日付の新しい順</option>
                        <option value="dateAsc">日付の古い順</option>
                        <option value="amountDesc">金額の高い順</option>
                        <option value="amountAsc">金額の低い順</option>
                    </select>
                    <button id="applyFilterBtn" class="btn btn-secondary">適用</button>
                </div>
            </div>

            <div class="custom-period hidden" id="customPeriodSection">
                <div class="date-inputs">
                    <div class="date-input">
                        <label for="startDate">開始日:</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="date-input">
                        <label for="endDate">終了日:</label>
                        <input type="date" id="endDate">
                    </div>
                </div>
            </div>

            <div class="receipt-list" id="receiptList">
                <!-- レシートアイテムが動的に挿入されます -->
                <div class="empty-state">
                    <i class="fas fa-receipt fa-3x"></i>
                    <p>レシートがありません</p>
                    <p>撮影タブでレシートを追加してください</p>
                </div>
            </div>
        </div>

        <div class="tab-content" id="analysis-tab">
            <div class="section-header">
                <h2><i class="fas fa-chart-pie"></i> 支出分析</h2>
                <div class="analysis-period">
                    <select id="analysisPeriod" class="filter-select">
                        <option value="month">今月</option>
                        <option value="lastMonth">先月</option>
                        <option value="3months">直近3ヶ月</option>
                        <option value="year">今年</option>
                        <option value="custom">カスタム期間</option>
                    </select>
                    <select id="analysisCategory" class="filter-select">
                        <option value="all">すべてのカテゴリ</option>
                        <option value="food">食料品</option>
                        <option value="daily_goods">日用品</option>
                        <option value="misc">雑貨</option>
                        <option value="clothing">衣服</option>
                        <option value="luxury">嗜好品</option>
                        <option value="other">その他</option>
                    </select>
                </div>
            </div>

            <div class="stats-cards">
                <div class="stat-card">
                    <div class="stat-value" id="totalAmount">¥0</div>
                    <div class="stat-label">合計支出</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="receiptCount">0</div>
                    <div class="stat-label">レシート数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgAmount">¥0</div>
                    <div class="stat-label">平均支出</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="topCategory">-</div>
                    <div class="stat-label">最多カテゴリ</div>
                </div>
            </div>

            <div class="chart-container">
                <h3><i class="fas fa-chart-pie"></i> カテゴリ別支出</h3>
                <canvas id="categoryChart"></canvas>
            </div>

            <div class="chart-container">
                <h3><i class="fas fa-chart-bar"></i> 店舗別支出TOP5</h3>
                <canvas id="storeChart"></canvas>
            </div>

            <div class="chart-container">
                <h3><i class="fas fa-chart-line"></i> 期間別推移</h3>
                <canvas id="trendChart"></canvas>
            </div>


            <div class="analysis-section">
                <h3><i class="fas fa-shopping-basket"></i> よく買う商品</h3>
                <div id="topProducts" class="product-list">
                    <!-- 商品リストが動的に挿入されます -->
                </div>
            </div>
        </div>

        <div class="tab-content" id="settings-tab">
            <div class="section-header">
                <h2><i class="fas fa-cog"></i> 設定</h2>
            </div>

            <div class="settings-section">


                <div class="api-key-section"
                    style="margin-bottom: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                    <h4><i class="fas fa-key"></i> Gemini API設定</h4>
                    <p style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">
                        高精度な読み取りと誤字修正のためにGoogle Gemini APIを使用します。
                    </p>
                    <div class="form-group">
                        <label for="geminiApiKey">API Key:</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="password" id="geminiApiKey" placeholder="AIzaSy..." style="flex: 1;">
                            <button id="saveApiKeyBtn" class="btn btn-primary btn-small">保存</button>
                        </div>
                        <p id="apiKeyStatus" style="font-size: 0.8rem; margin-top: 0.3rem;"></p>
                    </div>
                </div>


            </div>

            <div class="settings-section">
                <h3><i class="fas fa-database"></i> データ管理</h3>
                <div class="data-controls">
                    <button id="exportDataBtn" class="btn btn-secondary">
                        <i class="fas fa-download"></i> データをエクスポート
                    </button>
                    <label for="importFileInput" id="importDataBtn" class="btn btn-secondary">
                        <i class="fas fa-upload"></i> データをインポート
                    </label>
                    <button id="clearDataBtn" class="btn btn-danger">
                        <i class="fas fa-trash"></i> 全データを削除
                    </button>
                    <input type="file" id="importFileInput" class="hidden" accept=".json">
                </div>
                <p class="data-info">
                    現在の保存件数: <span id="dataCount">0</span>件
                </p>
            </div>

            <div class="settings-section">
                <h3><i class="fas fa-info-circle"></i> アプリ情報</h3>
                <div class="app-info">
                    <p><strong>バージョン:</strong> 1.0.0</p>
                    <p><strong>技術:</strong> HTML/CSS/JavaScript, Tesseract.js, IndexedDB</p>
                    <p><strong>説明:</strong> レシートを撮影して自動で家計簿を作成できるWebアプリです。</p>
                </div>
            </div>
        </div>

        <!-- レシート詳細/編集モーダル -->
        <div id="receiptModal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>レシート詳細</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="receiptForm">
                        <div class="form-group form-group-horizontal">
                            <label for="editDate">日付:</label>
                            <input type="date" id="editDate" required>
                        </div>
                        <div class="form-group form-group-horizontal">
                            <label for="editStore">店舗名:</label>
                            <input type="text" id="editStore" required>
                        </div>
                        <div class="form-group total-amount-group">
                            <label for="editTotal">合計金額</label>
                            <div class="total-input-wrapper">
                                <input type="number" id="editTotal" required min="0" placeholder="0">
                                <span class="currency-unit">円</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>商品リスト:</label>
                            <div class="items-header-row">
                                <span>商品名</span>
                                <span>価格</span>
                                <span>カテゴリ</span>
                                <span></span>
                            </div>
                            <div id="editItemsContainer" class="items-container">
                                <!-- 動的にアイテム行が追加されます -->
                            </div>
                            <button type="button" id="addItemBtn" class="btn btn-secondary btn-small">
                                <i class="fas fa-plus"></i> 商品を追加
                            </button>
                            <div id="itemsSummary" class="items-summary-text">
                                <!-- 合計と差額がここに表示されます -->
                            </div>
                        </div>
                        <div class="form-group hidden">
                            <label>レシート画像:</label>
                            <div class="modal-image-container">
                                <img id="editImagePreview" src="" alt="レシート画像" class="hidden">
                                <div id="noImageText" class="no-image-text">画像がありません</div>
                            </div>
                            <div class="modal-image-actions">
                                <label for="fileInput" id="changeImageBtn" class="btn btn-secondary btn-small">
                                    <i class="fas fa-image"></i> 画像を変更・追加
                                </label>
                                <button type="button" id="removeImageBtn" class="btn btn-danger btn-small hidden">
                                    <i class="fas fa-times"></i> 削除
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editMemo">メモ:</label>
                            <textarea id="editMemo" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button id="saveReceiptBtn" class="btn btn-primary">保存</button>
                    <button id="deleteReceiptBtn" class="btn btn-danger">削除</button>
                    <button class="btn btn-secondary modal-close">キャンセル</button>
                </div>
            </div>
        </div>

        <!-- 確認モーダル -->
        <div id="confirmModal" class="modal hidden">
            <div class="modal-content small">
                <div class="modal-body">
                    <p id="confirmMessage">本当に削除しますか？</p>
                </div>
                <div class="modal-footer">
                    <button id="confirmOk" class="btn btn-danger">はい</button>
                    <button id="confirmCancel" class="btn btn-secondary">キャンセル</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="js/main.js"></script>
</body>

</html>
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
        });
    }
</script>